<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Control de M√≥viles ‚Äì Panel</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  .guardia{
    display: none;
  }

  /* === MODO CLARO (blanco con tonos suaves) === */
  body {
    background: radial-gradient(circle at center, #ffffff 0%, #f3f4f6 100%);
    color: #111;
  }

  .card {
    background: #ffffff;
    border-radius: 14px;
    border: 1px solid #ddd;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    color: #111;
  }

  .table-dark td,
  .table-dark th {
    color: #111;
    background: #f8f9fa;
    border-color: #ddd;
  }

  .chart-card {
    padding: 14px;
    background: #fff;
    border-radius: 14px;
    border: 1px solid #ddd;
  }

  .chart-card canvas {
    max-height: 420px;
  }

  .brand-blue { background: #0d6efd; color: #fff; }
  .brand-red { background: #dc3545; color: #fff; }

  .nav-tabs .nav-link {
    color: #444;
    border-color: transparent;
  }

  .nav-tabs .nav-link.active {
    color: #fff;
    background: #0d6efd;
    border-color: #0d6efd;
  }

  /* Opcional: tablas, selects y encabezados */
  table, th, td {
    color: #111 !important;
  }

  select, input, button {
    color: #111 !important;
    background: #fff !important;
    border: 1px solid #ccc !important;
  }

  h1, h2, h3, h4, h5 {
    color: #111;
  }

.chart-scroll-x {
  width: 100%;
  overflow-x: auto !important;   /* ‚úÖ scroll horizontal */
  overflow-y: hidden !important; /* evita scroll vertical */
  padding-bottom: 8px;
  border-radius: 10px;
  scrollbar-width: thin;
  scrollbar-color: #ccc #f8f9fa;
}

.chart-scroll-x::-webkit-scrollbar {
  height: 8px;
}

.chart-scroll-x::-webkit-scrollbar-thumb {
  background: #aaa;
  border-radius: 4px;
}

.chart-scroll-x::-webkit-scrollbar-thumb:hover {
  background: #666;
}

.chart-scroll-x canvas {
  display: block;
  min-width: 1200px; /* ‚úÖ obliga al scroll a aparecer */
}




</style>

</head>
<body class="bg-white text-dark">

<!-- ‚úÖ NAVBAR GLOBAL -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
  <div class="container-fluid">
    <!-- üîπ Marca / T√≠tulo -->
    <a class="navbar-brand fw-bold" href="#">üöê Control de M√≥viles</a>

    <!-- üîπ Bot√≥n hamburguesa (m√≥vil) -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu" aria-controls="navbarMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- üîπ Enlaces -->
    <div class="collapse navbar-collapse" id="navbarMenu">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active" href="index.html">
            <i class="bi bi-grid-fill me-1"></i> Resumen
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="choferes.html">
            <i class="bi bi-person-vcard me-1"></i> Choferes
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="oficial.html">
            <i class="bi bi-people-fill me-1"></i> Oficiales
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="comparacion-acomp.html">
            <i class="bi bi-bar-chart-line me-1"></i> Comparaciones
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>
<!-- üîπ Fin del navbar -->





<div class="container py-4">
  <h2 class="text-center fw-bold mb-4">üìä Control de M√≥viles ‚Äì Salida de Guardia</h2>

  <!-- Carga -->
  <div class="card p-3 mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-md-6">
        <label class="form-label">üìÇ Cargar Excel (.xlsx) ‚Äî Hoja: <strong>BBDD Guardia</strong></label>
        <input type="file" id="fileInput" accept=".xlsx" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">üìÖ Mes</label>
        <select id="selMes" class="form-select" disabled>
          <option value="Todos">Todos</option>
        </select>
      </div>
      <div class="col-md-3 guardia">
        <label class="form-label">üë∑ Guardia</label>
        <select id="selGuardia" class="form-select" disabled>
          <option value="Todas">Todas</option>
        </select>
      </div>
    </div>
    <small class="text-secondary d-block mt-2">
      El sistema ignora filas con <code>SALIDA TARDE</code> vac√≠o o <code>#N/A</code> y considera solo la <strong>Primera salida</strong>.
    </small>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" id="tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-resumen" type="button" role="tab">Resumen</button>
    </li>
    
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-mes" type="button" role="tab">Por mes</button>
    </li>

  </ul>

  <div class="tab-content">

  <!-- RESUMEN -->
  <div class="tab-pane fade show active" id="tab-resumen" role="tabpanel">
    <div class="row g-4 align-items-stretch">
      <div class="col-lg-8">
        <div class="card chart-card">
          <canvas id="chResumen"></canvas>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card p-3 h-100">
          <h5 class="text-center mb-3">‚è±Ô∏è Tiempos Promedio</h5>
          <table class="table table-dark table-bordered text-center">
            <thead class="table-secondary text-dark">
              <tr><th>Categor√≠a</th><th>Promedio</th></tr>
            </thead>
            <tbody id="tbPromedios"></tbody>
          </table>
          <div id="lblTotal" class="text-center text-secondary small"></div>
        </div>
      </div>
    </div>
  </div>


  <!-- POR MES -->
  <div class="tab-pane fade" id="tab-mes" role="tabpanel">
    <div class="card chart-card">
      <canvas id="chMeses"></canvas>
    </div>
  </div>


 <!-- CHOFERES -->
<div class="tab-pane fade" id="tab-choferes" role="tabpanel">

  <!-- üîπ Filtros independientes -->
  <div class="row g-3 mt-3 mb-3">
    <div class="col-md-6">
      <label for="selMesChofer" class="form-label fw-semibold">üìÖ Mes (Choferes)</label>
      <select id="selMesChofer" class="form-select" disabled>
        <option value="Todos">Todos</option>
      </select>
    </div>
    <div class="col-md-6">
      <label for="selChofer" class="form-label fw-semibold">üë∑ Filtrar por chofer:</label>
      <select id="selChofer" class="form-select" disabled>
        <option value="Todos">Todos</option>
      </select>
    </div>
  </div>

  <!-- üîπ Contenedor con scroll (para TODOS) -->
  <div id="contenedorChoferScroll" class="card chart-card chart-scroll-x">
    <canvas id="chChoferScroll" height="480"></canvas>
  </div>

  <!-- üîπ Contenedor centrado (para UNO) -->
  <div id="contenedorChoferSimple" class="card chart-card d-none text-center">
    <canvas id="chChoferSimple" height="420" style="width:600px; max-width:90%;"></canvas>
  </div>

</div>



  <!-- ACOMPA√ëANTES -->
<div class="tab-pane fade display:none" id="tab-acomp" role="tabpanel">

  <!-- üîπ Filtro de acompa√±ante -->
  <div class="mt-3">
    <label for="selAcomp" class="form-label fw-semibold">Filtrar por acompa√±ante:</label>
    <select id="selAcomp" class="form-select mb-3" disabled>
      <option value="Todos">Todos</option>
    </select>
  </div>

  <!-- üîπ Contenedor con scroll (para TODOS) -->
  <div id="contenedorAcompScroll" class="card chart-card chart-scroll-x">
    <canvas id="chAcompScroll" height="480"></canvas>
  </div>

  <!-- üîπ Contenedor centrado (para UNO) -->
  <div id="contenedorAcompSimple" class="card chart-card d-none text-center">
    <canvas id="chAcompSimple" height="420" style="width:600px; max-width:90%;"></canvas>
  </div>

</div>


</div>


  </div>
</div>




<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>


<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>


<script>
/* =========================
   UTILIDADES DE TIEMPO
========================= */
function toSeconds(hhmmss) {
  if (hhmmss == null || hhmmss === "" || hhmmss === "#N/A") return null;
  const str = hhmmss.toString().trim();

  if (!isNaN(str) && str.includes(".")) {
    const horasDecimal = parseFloat(str) * 24;
    return horasDecimal * 3600;
  }

  const partes = str.split(":").map(Number);
  if (partes.length === 2) {
    const [m, s] = partes;
    return m * 60 + s;
  }
  if (partes.length === 3) {
    const [h, m, s] = partes;
    return h * 3600 + m * 60 + s;
  }
  return null;
}

const fmtHHMMSS = (sec) => {
  if (!sec && sec !== 0) return "-";
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = Math.floor(sec % 60);
  return [h, m, s].map(v => String(v).padStart(2, "0")).join(":");
};

/* =========================
   ESTADO GLOBAL
========================= */
let DATA = [];
let charts = {};
const el = (id) => document.getElementById(id);
const MONTH_NAMES = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

/* =========================
   CARGA EXCEL PRINCIPAL
========================= */
el("fileInput").addEventListener("change", (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = (evt) => {
    const wb = XLSX.read(evt.target.result, { type: "binary" });
    const sheet = wb.Sheets["BBDD Guardia"] || wb.Sheets[wb.SheetNames[0]];
    if (!sheet) { alert("No se encontr√≥ la hoja BBDD Guardia."); return; }

    const raw = XLSX.utils.sheet_to_json(sheet);

    DATA = raw.filter(r => {
      const ps = (r["Primera Salida"] ?? r["PRIMERA SALIDA"] ?? "").toString().toLowerCase();
      const isFirst = ps.includes("primera");
      const st = (r["SALIDA TARDE"] ?? "").toString().trim();
      const validST = st && st !== "#N/A";
      return isFirst && validST;
    }).map(r => {
      let salida = (r["SALIDA TARDE"] || "").toString().trim();
      if (/^en\s*horario/i.test(salida)) salida = "En horario";
      else salida = "Sali√≥ Tarde";
      return {
        FECHA: r["FECHA"],
        HORA: r["HORA"],
        GUARDIA: r["GUARDIA"] ?? "",
        CHOFER: r["CHOFER"] ?? "",
        ACOMPA√ëANTE: r["ACOMPA√ëANTE"] ?? "",
        ROTACION_CHOFER: r["ROTACION DEL CHOFER"] ?? "",
        DIF_HS: r["DIFERENCIA DE HS"],
        MES: r["Mes"],
        SALIDA_TARDE: salida
      };
    });

    // Poblar selects principales
    const meses = [...new Set(DATA.map(d => d.MES).filter(v => v !== "" && v != null))].sort((a, b) => a - b);
    el("selMes").innerHTML = `<option value="Todos">Todos</option>` + meses.map(m => `<option value="${m}">${MONTH_NAMES[(+m || 0) - 1] || m}</option>`).join("");
    el("selMes").disabled = false;

    const guardias = [...new Set(DATA.map(d => d.GUARDIA).filter(v => v !== "" && v != null))].sort();
    el("selGuardia").innerHTML = `<option value="Todas">Todas</option>` + guardias.map(g => `<option value="${g}">${g}</option>`).join("");
    el("selGuardia").disabled = false;

    // üîπ Poblar select de mes para Choferes
    const opcionesMesChofer = `<option value="Todos">Todos</option>` +
  [...new Set(DATA.map(d => d.MES).filter(v => v !== "" && v != null))]
  .sort((a, b) => a - b)
  .map(m => `<option value="${m}">${MONTH_NAMES[(+m || 0) - 1] || m}</option>`)
  .join("");




    renderAll();                // üîπ Render principal

  };
  reader.readAsBinaryString(f);
});

el("selMes").addEventListener("change", renderAll);
el("selGuardia").addEventListener("change", renderAll);

/* =========================
   HELPERS
========================= */
function datasetFiltrado() {
  const m = el("selMes").value;
  const g = el("selGuardia").value;
  return DATA.filter(d => {
    const okMes = (m === "Todos") || (String(d.MES) === String(m));
    const okG = (g === "Todas") || (String(d.GUARDIA) === String(g));
    return okMes && okG;
  });
}

function groupBy(arr, keyFn) {
  const map = new Map();
  for (const item of arr) {
    const k = keyFn(item);
    if (!map.has(k)) map.set(k, []);
    map.get(k).push(item);
  }
  return map;
}

function avgSeconds(items) {
  if (!items.length) return null;
  const validos = items.map(i => i.DIF_HS ? i.DIF_HS.toString().trim() : "")
    .filter(v => v !== "" && v !== "#N/A" && v.toLowerCase() !== "na");
  if (!validos.length) return null;
  const segundos = validos.map(v => toSeconds(v)).filter(v => v !== null && !isNaN(v));
  if (!segundos.length) return null;
  const total = segundos.reduce((a, b) => a + b, 0);
  return total / segundos.length;
}

/* =========================
   RENDER PRINCIPAL (sin acompa√±antes)
========================= */
function renderAll() {
  const rows = datasetFiltrado();

  const byEstado = groupBy(rows, r => r.SALIDA_TARDE);
  const enHorario = byEstado.get("En horario")?.length || 0;
  const tarde = byEstado.get("Sali√≥ Tarde")?.length || 0;
  const total = enHorario + tarde;
  const pct = (n) => total ? Math.round((n / total) * 100) : 0;

  // Promedios
  const pEnHor = avgSeconds(byEstado.get("En horario") || []);
  const pTarde = avgSeconds(byEstado.get("Sali√≥ Tarde") || []);
  const pTotal = avgSeconds(rows); // ‚úÖ promedio total sobre todas las muestras filtradas

  // Tabla de promedios
  el("tbPromedios").innerHTML = `
    <tr><td>Promedio total (todos)</td><td>${fmtHHMMSS(pTotal)}</td></tr>
    <tr><td>En horario (&lt;20 MIN)</td><td>${fmtHHMMSS(pEnHor)}</td></tr>
    <tr><td>Sali√≥ Tarde</td><td>${fmtHHMMSS(pTarde)}</td></tr>
  `;
  el("lblTotal").textContent = `Muestras: ${total} (En horario: ${enHorario} ‚Ä¢ Tarde: ${tarde})`;

  // Gr√°fico resumen
  drawBar(
    "chResumen",
    ["En horario", "Sali√≥ Tarde"],
    [pct(enHorario), pct(tarde)],
    "% m√≥viles",
    ["#0d6efd", "#dc3545"],
    "SALIDA DE M√ìVILES",
    "porcentaje"
  );

  // --- Por mes ---
  const byMes = groupBy(datasetFiltradoMesIndependiente(), r => r.MES);
  const meses = [...byMes.keys()].sort((a, b) => a - b);
  const dataEn = meses.map(m => {
    const arr = byMes.get(m) || []; const t = arr.length;
    const en = arr.filter(r => r.SALIDA_TARDE === "En horario").length;
    return t ? Math.round(en / t * 100) : 0;
  });
  const dataTa = meses.map(m => {
    const arr = byMes.get(m) || []; const t = arr.length;
    const ta = arr.filter(r => r.SALIDA_TARDE !== "En horario").length;
    return t ? Math.round(ta / t * 100) : 0;
  });
  drawGroupedBars(
    "chMeses",
    meses.map(m => MONTH_NAMES[(+m || 0) - 1] || m),
    [
      { label: "En horario", data: dataEn, bg: "#0d6efd" },
      { label: "Sali√≥ Tarde", data: dataTa, bg: "#dc3545" }
    ],
    "porcentaje"
  );


}


function datasetFiltradoMesIndependiente() {
  const g = el("selGuardia").value;
  return DATA.filter(d => (g === "Todas") || (String(d.GUARDIA) === String(g)));
}



/* =========================
   DASHBOARD APARTE: CHOFERES
========================= */
function initChoferDashboard() {
  if (!DATA.length) return;
  const choferSet = [...new Set(DATA.map(d => d.CHOFER).filter(v => v && v.trim() !== ""))].sort();
  const sel = el("selChofer");
  sel.innerHTML = `<option value="Todos">Todos</option>` + choferSet.map(c => `<option value="${c}">${c}</option>`).join("");
  sel.disabled = false;

  sel.addEventListener("change", () => renderChofer(sel.value));
  renderChofer("Todos");
}


function renderChofer(filtro = "Todos") {
  const filtroNormalizado = filtro.trim().toLowerCase();

  // üîπ Seleccionamos los dos contenedores
  const contScroll = el("contenedorChoferScroll");
  const contSimple = el("contenedorChoferSimple");
  const canvasScroll = el("chChoferScroll");
  const canvasSimple = el("chChoferSimple");

  // üîπ Limpiamos los gr√°ficos anteriores
  destroyChart("chChoferScroll");
  destroyChart("chChoferSimple");

  // üîπ Mostrar el contenedor correcto seg√∫n el filtro
  if (filtro === "Todos") {
    contScroll.classList.remove("d-none");
    contSimple.classList.add("d-none");
  } else {
    contScroll.classList.add("d-none");
    contSimple.classList.remove("d-none");
  }

  // ==========================
  //   FILTRO POR MES
  // ==========================
  const mesSeleccionado = el("selMesChofer") ? el("selMesChofer").value : "Todos";

  const base = DATA.filter(d => {
    if (mesSeleccionado === "Todos") return true;
    const mesNum = String(d.MES);
    const mesNombre = MONTH_NAMES[(+mesNum || 0) - 1];
    return (
      mesNum === mesSeleccionado ||
      mesNombre === mesSeleccionado
    );
  });

  // ==========================
  //   FILTRO POR CHOFER
  // ==========================
  const rows = filtro === "Todos"
    ? base
    : base.filter(r => (r.CHOFER || "").trim().toLowerCase() === filtroNormalizado);

  // ==========================
  //   AGRUPAR Y CALCULAR %
  // ==========================
  const byC = groupBy(rows, r => r.CHOFER || "(sin chofer)");
  const choferes = [];

  for (const [nom, arr] of byC.entries()) {
    const total = arr.length;
    const enHorario = arr.filter(r => r.SALIDA_TARDE === "En horario").length;
    const tarde = arr.filter(r => r.SALIDA_TARDE === "Sali√≥ Tarde").length;
    const pctEn = total ? Math.round((enHorario / total) * 100) : 0;
    const pctTa = total ? Math.round((tarde / total) * 100) : 0;
    choferes.push({ nom, pctEn, pctTa });
  }

  // Ordenar de mayor a menor % en horario
  choferes.sort((a, b) => b.pctEn - a.pctEn);

  const labels = choferes.map(x => x.nom);
  const datasetEn = choferes.map(x => x.pctEn);
  const datasetTa = choferes.map(x => x.pctTa);

  // ==========================
  //   CONFIGURAR GR√ÅFICO
  // ==========================
  const canvas = filtro === "Todos" ? canvasScroll : canvasSimple;
  const ctx = canvas.getContext("2d");

  const ancho = filtro === "Todos"
    ? Math.max(1200, labels.length * 90)
    : 600;
  canvas.width = ancho;

  charts[filtro === "Todos" ? "chChoferScroll" : "chChoferSimple"] = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "En horario",
          data: datasetEn,
          backgroundColor: "#0d6efd",
          barThickness: 30
        },
        {
          label: "Sali√≥ Tarde",
          data: datasetTa,
          backgroundColor: "#dc3545",
          barThickness: 30
        }
      ]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: "#111" }
        },
        title: {
          display: true,
          text: filtro === "Todos"
            ? "Choferes - En horario vs Sali√≥ tarde"
            : `Desempe√±o de ${filtro}`,
          color: "#111",
          font: { size: 18, weight: "bold" }
        }
      },
      scales: {
        x: {
          ticks: { color: "#333", autoSkip: false, maxRotation: 35, minRotation: 35 },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: { color: "#333", callback: v => v + "%" },
          grid: { color: "rgba(0,0,0,0.08)" }
        }
      }
    },
    plugins: [addLabelsPlugin("porcentaje")]
  });
}



/* =========================
   DASHBOARD APARTE: ACOMPA√ëANTES
========================= */

function initAcompananteDashboard() {
  if (!DATA.length) return;
  const acompSet = [...new Set(DATA.map(d => d.ACOMPA√ëANTE).filter(v => v && v.trim() !== ""))].sort();
  const sel = el("selAcomp");
  sel.innerHTML = `<option value="Todos">Todos</option>` + acompSet.map(a => `<option value="${a}">${a}</option>`).join("");
  sel.disabled = false;

  sel.addEventListener("change", () => renderAcomp(sel.value));
  renderAcomp("Todos");
}



function renderAcomp(filtro = "Todos") {
  const filtroNormalizado = filtro.trim().toLowerCase();

  // üîπ Referencias a los dos contenedores
  const contScroll = el("contenedorAcompScroll");
  const contSimple = el("contenedorAcompSimple");
  const canvasScroll = el("chAcompScroll");
  const canvasSimple = el("chAcompSimple");

  // üîπ Limpiar gr√°ficos previos
  destroyChart("chAcompScroll");
  destroyChart("chAcompSimple");

  // üîπ Alternar contenedores seg√∫n filtro
  if (filtro === "Todos") {
    contScroll.classList.remove("d-none");
    contSimple.classList.add("d-none");
  } else {
    contScroll.classList.add("d-none");
    contSimple.classList.remove("d-none");
  }

  // üîπ Filtrar datos
  const rows = filtro === "Todos"
    ? DATA
    : DATA.filter(r => (r.ACOMPA√ëANTE || "").trim().toLowerCase() === filtroNormalizado);

  const byA = groupBy(rows, r => r.ACOMPA√ëANTE || "(sin acompa√±ante)");
  const acomp = [];

  for (const [nom, arr] of byA.entries()) {
    const t = arr.length;
    const en = arr.filter(r => r.SALIDA_TARDE === "En horario").length;
    const ta = arr.filter(r => r.SALIDA_TARDE === "Sali√≥ Tarde").length;
    const pctEn = t ? Math.round((en / t) * 100) : 0;
    const pctTa = t ? Math.round((ta / t) * 100) : 0;
    acomp.push({ nom, pctEn, pctTa });
  }

  acomp.sort((a, b) => b.pctEn - a.pctEn);

  const labels = acomp.map(x => x.nom);
  const datasetEn = acomp.map(x => x.pctEn);
  const datasetTa = acomp.map(x => x.pctTa);

  // ‚úÖ Determinar cu√°l canvas usar
  const canvas = filtro === "Todos" ? canvasScroll : canvasSimple;
  const ctx = canvas.getContext("2d");

  // üîπ Ancho din√°mico o compacto
  const ancho = filtro === "Todos"
    ? Math.max(1200, labels.length * 90)
    : 600;
  canvas.width = ancho;

  charts[filtro === "Todos" ? "chAcompScroll" : "chAcompSimple"] = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "En horario",
          data: datasetEn,
          backgroundColor: "#0d6efd",
          barThickness: 30
        },
        {
          label: "Sali√≥ Tarde",
          data: datasetTa,
          backgroundColor: "#dc3545",
          barThickness: 30
        }
      ]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: "#111" } },
        title: {
          display: true,
          text: filtro === "Todos"
            ? "Acompa√±antes - En horario vs Sali√≥ tarde"
            : `Desempe√±o de ${filtro} (% en horario vs tarde)`,
          color: "#111",
          font: { size: 18, weight: "bold" }
        }
      },
      scales: {
        x: {
          ticks: { color: "#333", autoSkip: false, maxRotation: 35, minRotation: 35 },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: { color: "#333", callback: v => v + "%" },
          grid: { color: "rgba(0,0,0,0.08)" }
        }
      }
    },
    plugins: [addLabelsPlugin("porcentaje")]
  });
}




/* =========================
   CHART HELPERS Y FUNCIONES DRAW
========================= */
function destroyChart(id) { if (charts[id]) { charts[id].destroy(); delete charts[id]; } }

function addLabelsPlugin(mode) {
  return {
    id: 'labels',
    afterDatasetsDraw(chart) {
      const ctx = chart.ctx;
      chart.data.datasets.forEach((ds, di) => {
        const meta = chart.getDatasetMeta(di);
        if (!meta || !meta.data) return;
        meta.data.forEach((bar, i) => {
          const val = ds.data[i];
          if (val == null || isNaN(val)) return;
          const texto = mode === "porcentaje" ? `${val}%` : val;
          const pos = bar.tooltipPosition();
          ctx.save();
          ctx.fillStyle = "#111";
          ctx.font = "bold 13px system-ui";
          ctx.textAlign = "center";
          ctx.textBaseline = "bottom";
          ctx.fillText(texto, pos.x, pos.y - 6);
          ctx.restore();
        });
      });
    }
  };
}

function drawBar(id, labels, data, yLabel, colors, title, mode) {
  destroyChart(id);
  const ctx = el(id).getContext("2d");
  charts[id] = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
    options: {
      plugins: {
        legend: { display: false },
        title: { display: true, text: title, color: "#111", font: { size: 18, weight: "bold" } },
        tooltip: { callbacks: { label: (c) => mode === "porcentaje" ? `${c.parsed.y}%` : c.parsed.y } }
      },
      scales: {
        x: { ticks: { color: "#333" }, grid: { display: false } },
        y: { beginAtZero: true, ticks: { color: "#333", callback: v => mode === "porcentaje" ? v + "%" : v }, grid: { color: "rgba(0,0,0,.08)" } }
      }
    },
    plugins: [addLabelsPlugin(mode)]
  });
}

function drawGroupedBarsChoferes(id, labels, series, mode, title) {
  destroyChart(id);
  const ctx = el(id).getContext("2d");
  charts[id] = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: series.map(s => ({ label: s.label, data: s.data, backgroundColor: s.bg })) },
    options: {
      responsive: false,
      maintainAspectRadio: false,
      plugins: {
        legend: { labels: { color: "#111" } },
        title: { display: true, text: title, color: "#111", font: { size: 18, weight: "bold" } },
        tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y}%` } }
      },
      scales: {
        x: { ticks: { color: "#333" }, grid: { display: false } },
        y: { beginAtZero: true, ticks: { color: "#333", callback: v => v + "%" }, grid: { color: "rgba(0,0,0,0.08)" } }
      }
    },
    plugins: [addLabelsPlugin(mode)]
  });
}

function drawGroupedBars(id, labels, series, mode) {
  destroyChart(id);
  const ctx = el(id).getContext("2d");
  charts[id] = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: series.map(s => ({ label: s.label, data: s.data, backgroundColor: s.bg })) },
    options: {
      plugins: {
        legend: { labels: { color: "#111" } },
        title: { display: true, text: "Evoluci√≥n mensual (%)", color: "#111", font: { size: 18, weight: "bold" } },
        tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y}%` } }
      },
      scales: {
        x: { ticks: { color: "#333" }, grid: { display: false } },
        y: { beginAtZero: true, ticks: { color: "#333", callback: v => v + "%" }, grid: { color: "rgba(0,0,0,0.08)" } }
      }
    },
    plugins: [addLabelsPlugin(mode)]
  });
}

function drawHorizontalBars(id, labels, data, title) {
  destroyChart(id);
  const ctx = el(id).getContext("2d");
  charts[id] = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ label: "% en horario", data, backgroundColor: "#0d6efd" }] },
    options: {
      indexAxis: "y",
      plugins: {
        legend: { display: false },
        title: { display: true, text: title, color: "#111", font: { size: 18, weight: "bold" } },
        tooltip: { callbacks: { label: c => `${c.parsed.x}%` } }
      },
      scales: {
        x: { beginAtZero: true, ticks: { color: "#333", callback: v => v + "%" }, grid: { color: "rgba(0,0,0,0.08)" } },
        y: { ticks: { color: "#333" }, grid: { display: false } }
      }
    },
    plugins: [addLabelsPlugin("porcentaje")]
  });
}
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
